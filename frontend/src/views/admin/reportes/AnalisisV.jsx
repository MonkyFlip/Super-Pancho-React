// src/views/admin/reportes/AnalisisV.jsx
import React, { useEffect, useState, useCallback, useRef } from 'react';
import { temas } from '../../../styles/temas';
import { ventasRegresionSimple, ventasRegresionMultiple } from '../../../services/api';
import { FaSync, FaChartLine, FaLayerGroup, FaDownload, FaInfoCircle } from 'react-icons/fa';
import { isAuthenticated, getStoredUser, getHomeRouteForUser } from '../../../services/auth';

import {
  Chart as ChartJS,
  LinearScale,
  PointElement,
  LineElement,
  CategoryScale,
  TimeScale,
  Tooltip,
  Legend,
  Filler,
} from 'chart.js';
import { Scatter, Line } from 'react-chartjs-2';
import 'chartjs-adapter-date-fns';

ChartJS.register(
  LinearScale,
  PointElement,
  LineElement,
  CategoryScale,
  TimeScale,
  Tooltip,
  Legend,
  Filler
);

const THEME_KEY = 'app_theme_selected';

const formatForDisplay = (v) => {
  if (v == null) return '';
  if (typeof v === 'string') return v;
  try { return JSON.stringify(v, null, 2); } catch { return String(v); }
};

const style = {
  container: { padding: 20 },
  card: (tema) => ({
    background: tema.fondo_card || tema.fondo || '#ffffff',
    padding: 14,
    borderRadius: 12,
    boxShadow: tema.sombra || '0 8px 24px rgba(8,15,30,0.06)',
    border: `1px solid ${tema.borde || '#eef2f7'}`
  }),
  headerRow: (tema) => ({ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 12 }),
  title: (tema) => ({ fontSize: 18, fontWeight: 700, color: tema.texto }),
  btnPrimary: (tema) => ({
    padding: '8px 12px',
    borderRadius: 10,
    border: 'none',
    background: tema.primario || '#2563eb',
    color: '#fff',
    cursor: 'pointer'
  }),
  btnGhost: (tema) => ({
    padding: '8px 10px',
    borderRadius: 10,
    border: `1px solid ${tema.borde}`,
    background: 'transparent',
    color: tema.texto,
    cursor: 'pointer'
  }),
  smallMuted: (tema) => ({ color: tema.subtexto || '#6b7280', fontSize: 13 })
};

export default function AnalisisV() {
  const [temaKey, setTemaKey] = useState(() => {
    try { return localStorage.getItem(THEME_KEY) || 'bosque_claro'; } catch { return 'bosque_claro'; }
  });
  const tema = temas[temaKey] || temas.bosque_claro;

  const [loading, setLoading] = useState(false);
  const [error, setError] = useState(null);
  const [simpleResult, setSimpleResult] = useState(null);
  const [multipleResult, setMultipleResult] = useState(null);
  const [mode, setMode] = useState('simple'); // 'simple' | 'multiple'
  const mountedRef = useRef(false);

  useEffect(() => { mountedRef.current = true; return () => { mountedRef.current = false; }; }, []);

  useEffect(() => {
    const onStorage = (e) => {
      if (!e) return;
      if (e.key === THEME_KEY) setTemaKey(e.newValue || 'bosque_claro');
    };
    window.addEventListener('storage', onStorage);
    return () => window.removeEventListener('storage', onStorage);
  }, []);

  const ensureAuth = useCallback(() => {
    if (!isAuthenticated()) {
      window.location.hash = '#/login';
      return false;
    }
    const user = getStoredUser();
    if (!user) { window.location.hash = '#/login'; return false; }
    const rolLocal = user?.rol ?? user?.role ?? '';
    const isAdminLocal = String(rolLocal).toLowerCase().includes('admin');
    if (!isAdminLocal) {
      window.location.hash = getHomeRouteForUser(user) || '#/login';
      return false;
    }
    return true;
  }, []);

  const mapSimpleToSeries = useCallback((body) => {
    if (!body || !body.ok) return { points: [] };
    const xs = (body.samples && body.samples.x) || [];
    const ys = (body.samples && body.samples.y) || [];
    const y_pred = (body.samples && body.samples.y_pred) || [];
    const points = xs.map((x, i) => ({ x: Number(x) * 1000, y: Number(ys[i] ?? null), y_pred: Number(y_pred[i] ?? null) }));
    return { points };
  }, []);

  const mapMultipleRespToSeries = useCallback((body) => {
    if (!body || !body.ok) return { features: [], series: [], targetSeries: { data: [] }, predSeries: { data: [] }, coefs: {}, intercept: null, X_matrix: [], y: [], y_pred: [] };
    const features = body.features || [];
    const X = (body.samples && body.samples.X_matrix) || [];
    const y = (body.samples && body.samples.y) || [];
    const y_pred = (body.samples && body.samples.y_pred) || [];
    const coefs = body.coef || {};
    const intercept = body.intercept ?? null;
    const series = features.map((f, idx) => ({
      name: f,
      data: X.map((row, i) => ({ x: i, y: row[idx] != null ? Number(row[idx]) : null }))
    }));
    const targetSeries = { name: 'target', data: y.map((val, i) => ({ x: i, y: Number(val) })) };
    const predSeries = { name: 'y_pred', data: y_pred.map((val, i) => ({ x: i, y: Number(val) })) };
    return { features, series, targetSeries, predSeries, coefs, intercept, X_matrix: X, y, y_pred };
  }, []);

  const fetchAll = useCallback(async () => {
    setLoading(true);
    setError(null);
    try {
      const simplePayload = { collection: 'ventas', x_field: 'fecha_ordinal', y_field: 'total', limit: 1000 };
      const respSimple = await ventasRegresionSimple(simplePayload);
      const bodySimple = respSimple?.data ?? respSimple;
      setSimpleResult({ raw: bodySimple, mapped: mapSimpleToSeries(bodySimple) });

      const multiplePayload = { collection: 'ventas', features: ['items_count', 'sum_precio', 'avg_precio'], target: 'total', limit: 1000 };
      const respMult = await ventasRegresionMultiple(multiplePayload);
      const bodyMult = respMult?.data ?? respMult;
      setMultipleResult({ raw: bodyMult, mapped: mapMultipleRespToSeries(bodyMult) });

    } catch (err) {
      const server = err.serverData ?? err.response?.data ?? err.message ?? String(err);
      setError(server);
    } finally {
      if (mountedRef.current) setLoading(false);
    }
  }, [mapSimpleToSeries, mapMultipleRespToSeries]);

  useEffect(() => {
    if (!ensureAuth()) return;
    fetchAll();
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, []);

  const handleRefresh = useCallback(() => {
    if (!ensureAuth()) return;
    fetchAll();
  }, [ensureAuth, fetchAll]);

  const downloadCSV = useCallback((rows, headers = []) => {
    if (!rows || !rows.length) return;
    const csvRows = [];
    if (headers.length) csvRows.push(headers.join(','));
    rows.forEach(r => {
      csvRows.push(Object.values(r).map(v => `"${String(v).replace(/"/g, '""')}"`).join(','));
    });
    const blob = new Blob([csvRows.join('\n')], { type: 'text/csv;charset=utf-8;' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `regresion_${mode}_${Date.now()}.csv`;
    document.body.appendChild(a);
    a.click();
    a.remove();
    URL.revokeObjectURL(url);
  }, [mode]);

  // --- Chart builders with white background and visible prediction line ---
  const buildSimpleChartData = useCallback(() => {
    const pts = simpleResult?.mapped?.points || [];
    return {
      datasets: [
        {
          label: 'Observado',
          data: pts.map(p => ({ x: p.x, y: p.y })),
          backgroundColor: 'rgba(30,64,175,0.95)',
          borderColor: 'rgba(30,64,175,0.95)',
          showLine: false,
          pointRadius: 3,
        },
        {
          label: 'Predicción',
          data: pts.map(p => ({ x: p.x, y: p.y_pred })),
          borderColor: 'rgba(5,150,105,0.98)',
          backgroundColor: 'rgba(5,150,105,0.12)',
          pointRadius: 0,
          tension: 0.25,
          showLine: true,
          borderWidth: 3,
          fill: false,
        }
      ]
    };
  }, [simpleResult]);

  const simpleOptions = {
    parsing: false,
    plugins: {
      legend: { display: true, labels: { boxWidth: 12, usePointStyle: true, color: tema.texto } },
      tooltip: { mode: 'nearest', intersect: false }
    },
    scales: {
      x: {
        type: 'time',
        time: { unit: 'day' },
        title: { display: true, text: 'Fecha', color: tema.texto },
        grid: { color: '#e6eef8' },
        ticks: { color: '#374151' }
      },
      y: {
        title: { display: true, text: 'Ventas totales del turno (u)', color: tema.texto },
        grid: { color: '#eef2f6' },
        ticks: { color: '#374151' }
      }
    },
    maintainAspectRatio: false,
    elements: { line: { tension: 0.25 } },
    layout: { padding: { top: 8, right: 12, bottom: 6, left: 6 } }
  };

  const buildMultipleChartData = useCallback(() => {
    const mapped = multipleResult?.mapped;
    if (!mapped) return { datasets: [] };
    const datasets = mapped.series.map((s, idx) => ({
      label: s.name,
      data: s.data,
      borderColor: `hsl(${(idx * 70) % 360} 65% 45%)`,
      backgroundColor: `hsla(${(idx * 70) % 360} 65% 45% / 0.06)`,
      showLine: true,
      tension: 0.12,
      pointRadius: 1,
      borderWidth: 1.5
    }));
    if (mapped.targetSeries?.data?.length) {
      datasets.push({
        label: 'Target',
        data: mapped.targetSeries.data,
        borderColor: 'rgba(190,24,93,0.96)',
        backgroundColor: 'rgba(190,24,93,0.06)',
        tension: 0.2,
        pointRadius: 0,
        borderWidth: 2
      });
    }
    if (mapped.predSeries?.data?.length) {
      datasets.push({
        label: 'Predicción',
        data: mapped.predSeries.data,
        borderColor: 'rgba(14,165,233,0.95)',
        backgroundColor: 'rgba(14,165,233,0.06)',
        tension: 0.2,
        pointRadius: 0,
        borderWidth: 3
      });
    }
    return { datasets };
  }, [multipleResult]);

  const multipleOptions = {
    parsing: false,
    plugins: {
      legend: { display: true, labels: { boxWidth: 12, color: tema.texto } },
      tooltip: { mode: 'index', intersect: false }
    },
    scales: {
      x: { type: 'linear', title: { display: true, text: 'Índice de muestra', color: tema.texto }, grid: { color: '#eef2f6' }, ticks: { color: '#374151' } },
      y: { title: { display: true, text: 'Valor', color: tema.texto }, grid: { color: '#eef2f6' }, ticks: { color: '#374151' } }
    },
    maintainAspectRatio: false,
    layout: { padding: { top: 8, right: 12, bottom: 6, left: 6 } }
  };

  // --- Human readable interpretations ---
  const interpretSimple = useCallback((raw) => {
    if (!raw || !raw.ok) return "No hay información para interpretar.";
    const pts = (raw.samples && raw.samples.x && raw.samples.y) ? raw.samples.x.map((x,i) => ({ x, y: raw.samples.y[i] })) : [];
    if (pts.length < 2) return "No hay suficientes puntos para una interpretación confiable.";
    // slope approximation using simple linear regression (same as backend but quick local)
    try {
      const xs = pts.map(p => Number(p.x));
      const ys = pts.map(p => Number(p.y));
      const n = xs.length;
      const meanX = xs.reduce((a,b)=>a+b,0)/n;
      const meanY = ys.reduce((a,b)=>a+b,0)/n;
      const num = xs.reduce((acc, xv, i) => acc + (xv-meanX)*(ys[i]-meanY), 0);
      const den = xs.reduce((acc, xv) => acc + (xv-meanX)**2, 0) || 1;
      const slope = num/den;
      const slopePerDay = slope * 86400; // because xs are epoch seconds
      const direction = slopePerDay > 0 ? 'aumento' : (slopePerDay < 0 ? 'descenso' : 'estable');
      // compute avg and recent trend
      const avg = ys.reduce((a,b)=>a+b,0)/n;
      const lastY = ys[ys.length-1];
      const pct = ((lastY - avg)/avg)*100;
      const trendText = `Tendencia: ${direction}. Cambio aproximado por día: ${Math.abs(slopePerDay).toFixed(2)} unidades. Último valor ${lastY.toFixed(2)}, promedio ${avg.toFixed(2)} (${pct.toFixed(1)}% respecto al promedio).`;
      return trendText;
    } catch (e) {
      return "No se pudo calcular la interpretación estadística.";
    }
  }, []);

  const interpretMultiple = useCallback((raw) => {
    if (!raw || !raw.ok) return "No hay información para interpretar.";
    const coefs = raw.coef || {};
    const n = raw.n || (raw.samples && raw.samples.y && raw.samples.y.length) || 0;
    if (!coefs || Object.keys(coefs).length === 0) return "No se detectaron coeficientes para interpretar.";
    // identify top positive and negative contributors
    const entries = Object.entries(coefs).map(([k,v]) => ({ k, v: Number(v) || 0 }));
    entries.sort((a,b) => Math.abs(b.v) - Math.abs(a.v)); // por magnitud
    const top = entries.slice(0,3);
    const readable = top.map(t => {
      const sign = t.v > 0 ? 'aumenta' : (t.v < 0 ? 'reduce' : 'sin efecto claro');
      return `${t.k}: ${Math.abs(t.v).toFixed(3)} (${sign} el target por unidad de feature)`;
    }).join('; ');
    const base = `Muestras usadas: ${n}. `;
    const advice = "Interpretación: coeficientes positivos indican asociación directa con el total; coeficientes negativos indican asociación inversa. Los valores grandes en magnitud tienen mayor impacto.";
    return base + readable + ". " + advice;
  }, []);

  const SimpleSummaryCard = () => (
    <div style={style.card(tema)}>
      <div style={style.headerRow(tema)}>
        <div>
          <div style={style.title(tema)}>Regresión simple</div>
          <div style={style.smallMuted(tema)}>Relaciona fecha (x) con total (y)</div>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <button onClick={() => { setMode('simple'); }} style={style.btnGhost(tema)} title="Ver simple"><FaChartLine /></button>
          <button onClick={() => downloadCSV((simpleResult?.mapped?.points || []).map(p => ({ x: p.x, y: p.y, y_pred: p.y_pred })), ['x','y','y_pred'])} style={style.btnGhost(tema)} title="Exportar CSV"><FaDownload /></button>
        </div>
      </div>

      <div style={{ marginTop: 12 }}>
        {loading && <div style={style.smallMuted(tema)}>Cargando datos...</div>}
        {!loading && simpleResult && simpleResult.mapped && (
          <>
            <div style={{ height: 360, background: '#ffffff', borderRadius: 8, padding: 8 }}>
              <Scatter data={buildSimpleChartData()} options={simpleOptions} />
            </div>

            <div style={{ display: 'flex', gap: 12, marginTop: 12 }}>
              <div style={{ flex: 1 }}>
                <strong>Puntos:</strong> {simpleResult.mapped.points.length}
              </div>
              <div style={{ flex: 1 }}>
                <strong>Modelo:</strong> {simpleResult.raw?.mode ?? 'collection'}
              </div>
            </div>

            <div style={{ marginTop: 12 }}>
              <div style={{ fontWeight: 700 }}>Resumen en lenguaje sencillo</div>
              <div style={{ marginTop: 6, ...style.smallMuted(tema) }}>
                {interpretSimple(simpleResult.raw)}
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );

  const MultipleSummaryCard = () => (
    <div style={style.card(tema)}>
      <div style={style.headerRow(tema)}>
        <div>
          <div style={style.title(tema)}>Regresión múltiple</div>
          <div style={style.smallMuted(tema)}>Compara features con el target para estimar impacto</div>
        </div>
        <div style={{ display: 'flex', gap: 8 }}>
          <button onClick={() => { setMode('multiple'); }} style={style.btnGhost(tema)} title="Ver multiple"><FaLayerGroup /></button>
          <button onClick={() => {
            const X = multipleResult?.mapped?.X_matrix || [];
            const features = multipleResult?.mapped?.features || [];
            const rows = X.map((r, i) => {
              const obj = { index: i, y: (multipleResult?.mapped?.y || [])[i] };
              features.forEach((f, idx) => obj[f] = r[idx]);
              return obj;
            });
            downloadCSV(rows, ['index', ...(multipleResult?.mapped?.features || []), 'y']);
          }} style={style.btnGhost(tema)} title="Exportar CSV"><FaDownload /></button>
        </div>
      </div>

      <div style={{ marginTop: 12 }}>
        {loading && <div style={style.smallMuted(tema)}>Cargando datos...</div>}
        {!loading && multipleResult && multipleResult.mapped && (
          <>
            <div style={{ height: 320, background: '#ffffff', borderRadius: 8, padding: 8 }}>
              <Line data={buildMultipleChartData()} options={multipleOptions} />
            </div>

            <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: 12, marginTop: 12 }}>
              <div style={{ background: '#fff', padding: 8, borderRadius: 8 }}>
                <div style={{ fontWeight: 700 }}>Features</div>
                <div style={style.smallMuted(tema)}>{formatForDisplay(multipleResult.mapped.features)}</div>
              </div>

              <div style={{ background: '#fff', padding: 8, borderRadius: 8 }}>
                <div style={{ fontWeight: 700 }}>Filas útiles</div>
                <div style={style.smallMuted(tema)}>{multipleResult.raw?.n ?? (multipleResult.mapped?.X_matrix?.length ?? 0)}</div>
              </div>
            </div>

            <div style={{ marginTop: 10, display: 'flex', gap: 12 }}>
              <div style={{ flex: 1 }}>
                <div style={{ fontWeight: 700 }}>Intercept</div>
                <div style={style.smallMuted(tema)}>{String(multipleResult.raw?.intercept ?? multipleResult.mapped.intercept ?? '-')}</div>
              </div>
              <div style={{ flex: 2 }}>
                <div style={{ fontWeight: 700 }}>Coeficientes (resumen)</div>
                <pre style={{ marginTop: 6, maxHeight: 120, overflow: 'auto', background: '#fafafa', padding: 8, borderRadius: 8 }}>{formatForDisplay(multipleResult.raw?.coef ?? multipleResult.mapped.coefs ?? {})}</pre>
              </div>
            </div>

            <div style={{ marginTop: 12 }}>
              <div style={{ fontWeight: 700 }}>Resumen en lenguaje sencillo</div>
              <div style={{ marginTop: 6, ...style.smallMuted(tema) }}>
                {interpretMultiple(multipleResult.raw)}
              </div>
            </div>
          </>
        )}
      </div>
    </div>
  );

  return (
    <div style={style.container}>
      <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', gap: 12, marginBottom: 14 }}>
        <div>
          <div style={style.title(tema)}>Panel de Análisis — Regresión</div>
          <div style={style.smallMuted(tema)}>Comparativa de modelos y visualización interactiva</div>
        </div>

        <div style={{ display: 'flex', gap: 10, alignItems: 'center' }}>
          <div style={{ display: 'flex', gap: 6 }}>
            <button onClick={() => setMode('simple')} style={{ ...(mode === 'simple' ? style.btnPrimary(tema) : style.btnGhost(tema)) }}>Simple</button>
            <button onClick={() => setMode('multiple')} style={{ ...(mode === 'multiple' ? style.btnPrimary(tema) : style.btnGhost(tema)) }}>Multiple</button>
          </div>
          <button onClick={handleRefresh} style={style.btnGhost(tema)} title="Actualizar"><FaSync />&nbsp;Actualizar</button>
        </div>
      </div>

      <div style={{ display: 'grid', gridTemplateColumns: '1fr 360px', gap: 16 }}>
        <div>
          {/* Descripción clara para el usuario */}
          <div style={{ marginBottom: 12 }}>
            <div style={{ display: 'flex', alignItems: 'center', gap: 8 }}>
              <FaInfoCircle style={{ color: '#2563eb' }} />
              <div style={{ fontWeight: 700 }}>Qué estás viendo</div>
            </div>
            <div style={{ marginTop: 8, ...style.smallMuted(tema) }}>
              <div><strong>Regresión simple:</strong> punto azul = ventas reales; línea verde = predicción del modelo. Si la línea sube con el tiempo, significa que las ventas tienden a aumentar; si baja, disminuyen.</div>
              <div style={{ height: 6 }} />
              <div><strong>Regresión múltiple:</strong> cada línea muestra cómo varía una característica (por ejemplo número de productos, suma de precios) a través de las muestras. La línea "Target" indica el valor real; la línea "Predicción" muestra lo que el modelo estima combinando las features.</div>
              <div style={{ height: 6 }} />
              <div><strong>Interpretación sencilla:</strong> lee el resumen en lenguaje natural abajo de cada gráfico; te dice la tendencia y las features con mayor efecto en el total.</div>
            </div>
          </div>

          {mode === 'simple' ? <SimpleSummaryCard /> : <MultipleSummaryCard />}
        </div>

        <div>
          <div style={style.card(tema)}>
            <div style={{ fontWeight: 700 }}>Resumen rápido</div>
            <div style={{ marginTop: 8 }}>
              <div style={{ display: 'flex', justifyContent: 'space-between' }}>
                <div style={style.smallMuted(tema)}>Estado</div>
                <div>{loading ? 'Cargando...' : 'Listo'}</div>
              </div>
              <div style={{ display: 'flex', justifyContent: 'space-between', marginTop: 6 }}>
                <div style={style.smallMuted(tema)}>Última consulta</div>
                <div>{new Date().toLocaleString()}</div>
              </div>

              <hr style={{ border: 'none', height: 1, background: tema.borde, margin: '12px 0' }} />

              <div style={{ fontWeight: 700 }}>Detalles técnicos</div>
              <div style={{ marginTop: 8, fontSize: 13 }}>
                <div><strong>Simple:</strong> {simpleResult ? `${simpleResult.mapped.points.length} puntos` : '—'}</div>
                <div><strong>Multiple:</strong> {multipleResult ? `${multipleResult.raw?.n ?? (multipleResult.mapped?.X_matrix?.length ?? 0)} filas` : '—'}</div>
              </div>

              <div style={{ marginTop: 12 }}>
                <details>
                  <summary style={{ cursor: 'pointer', color: tema.texto }}>Ver respuestas crudas</summary>
                  <div style={{ marginTop: 8 }}>
                    <div style={{ fontWeight: 700 }}>Simple (raw)</div>
                    <pre style={{ maxHeight: 140, overflow: 'auto', background: '#fafafa', padding: 8 }}>{formatForDisplay(simpleResult?.raw)}</pre>
                    <div style={{ fontWeight: 700 }}>Multiple (raw)</div>
                    <pre style={{ maxHeight: 140, overflow: 'auto', background: '#fafafa', padding: 8 }}>{formatForDisplay(multipleResult?.raw)}</pre>
                  </div>
                </details>
              </div>
            </div>
          </div>
        </div>
      </div>

      {error && (
        <div style={{ marginTop: 14 }}>
          <div style={{ ...style.card(tema), borderLeft: '4px solid #ef4444' }}>
            <div style={{ fontWeight: 700, color: '#b91c1c' }}>Error</div>
            <pre style={{ marginTop: 8 }}>{formatForDisplay(error)}</pre>
          </div>
        </div>
      )}
    </div>
  );
}
